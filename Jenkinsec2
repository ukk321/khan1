pipeline {
    agent any

    environment {
        // AWS Credentials
        AWS_ACCESS_KEY_ID = credentials('aws-access-key') 
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-key') 

        // AWS EC2 Details
        AWS_REGION = 'us-east-1' 
        EC2_USER = 'ubuntu' 
        EC2_IP = '98.82.178.99' 
        DEPLOY_DIR = '/var/www/html'  // Ensure this variable is correctly set
    }

    stages {
        stage('Fetch Source Code') {
            steps {
                git branch: 'main', url: 'https://github.com/ukk321/khan1.git'
            }
        }

        stage('Prepare Application') {
            steps {
                sh 'echo "Preparing application for deployment..."'
            }
        }

        stage('Quality Check') {
            steps {
                sh 'echo "Running quality checks and tests..."'
            }
        }

        stage('Deploy to EC2') {
            steps {
                sshagent(['ec2-ssh-key']) {
                    script {
                        try {
                            sh '''
                                echo "Creating deployment package..."
                                tar --exclude='./deployment.tar.gz' --exclude='./.git' --exclude='./.jenkins' --exclude='./logs' --exclude='./node_modules' -czf deployment.tar.gz .

                                echo "Copying package to EC2..."
                                scp -o StrictHostKeyChecking=no deployment.tar.gz ${EC2_USER}@${EC2_IP}:~
                                
                                echo "Deploying on EC2..."
                                ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_IP} '
                                    set -e
                                    
                                    DEPLOY_DIR="/var/www/html"  # ✅ Explicitly set DEPLOY_DIR
                                    echo "Ensuring deployment directory exists..."
                                    sudo mkdir -p "$DEPLOY_DIR"
                                    
                                    echo "Extracting deployment package..."
                                    sudo tar -xzf ~/deployment.tar.gz -C "$DEPLOY_DIR" --strip-components=1
                                    
                                    echo "Setting proper permissions..."
                                    sudo chown -R ubuntu:www-data "$DEPLOY_DIR"
                                    sudo chmod -R 755 "$DEPLOY_DIR"
                                    
                                    echo "Restarting web server..."
                                    sudo systemctl restart apache2 || sudo systemctl restart nginx
                                    
                                    echo "Cleaning up..."
                                    rm ~/deployment.tar.gz
                                    
                                    echo "Deployment completed successfully!"
                                '
                            '''
                        } catch (Exception e) {
                            echo "Deployment failed: ${e}"
                            currentBuild.result = 'FAILURE'
                            throw e
                        }
                    }
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                sh '''
                    if curl -Is http://${EC2_IP} | grep -E "200|301|302"; then
                        echo "Deployment successful!"
                    else
                        echo "Deployment verification failed!" && exit 1
                    fi
                '''
            }
        }

        stage('Cleanup') {
            steps {
                sh 'rm -f deployment.tar.gz || true'
            }
        }
    }

    post {
        success {
            echo '✅ GitHub to EC2 deployment pipeline executed successfully!'
        }
        failure {
            echo '❌ GitHub to EC2 deployment pipeline failed!'
        }
    }
}
