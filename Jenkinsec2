pipeline {
    agent any

    environment {
        // AWS Credentials (from Jenkins credentials)
        AWS_ACCESS_KEY_ID = credentials('aws-access-key')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-key')

        // AWS Region and EC2 details
        AWS_REGION = 'us-east-1'
        EC2_USER = 'ubuntu'
        EC2_IP = '98.82.178.99'
        DEPLOY_DIR = '/var/www/html'
    }

    stages {
        stage('Fetch Source Code') {
            steps {
                git branch: 'main', url: 'https://github.com/ukk321/khan1.git'
            }
        }

        stage('Prepare Application') {
            steps {
                sh 'echo "Preparing application for deployment..."'
            }
        }

        stage('Quality Check') {
            steps {
                sh 'echo "Running quality checks and tests..."'
            }
        }

        stage('Deploy to EC2') {
            steps {
                sshagent(['ec2-ssh-key']) {
                    script {
                        try {
                            sh '''
                                tar --exclude='./deployment.tar.gz' -czf deployment.tar.gz .
                                scp -o StrictHostKeyChecking=no deployment.tar.gz ${EC2_USER}@${EC2_IP}:~
                                ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_IP} "
                                    set -e
                                    echo 'Deploying application...'
                                    sudo mkdir -p ${DEPLOY_DIR}
                                    sudo tar -xzf ~/deployment.tar.gz -C ${DEPLOY_DIR} --strip-components=1
                                    sudo chown -R ubuntu:www-data ${DEPLOY_DIR}
                                    sudo chmod -R 755 ${DEPLOY_DIR}
                                    sudo systemctl restart apache2 || sudo systemctl restart nginx
                                    rm ~/deployment.tar.gz
                                    echo 'Deployment completed successfully'
                                "
                            '''
                        } catch (Exception e) {
                            echo "Deployment failed: ${e}"
                            currentBuild.result = 'FAILURE'
                            throw e
                        }
                    }
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                sh 'echo "Verifying deployment status..."'
                sh '''
                    if curl -Is http://${EC2_IP} | head -n 1 | grep -E "200|301|302"; then
                        echo "Deployment successful!"
                    else
                        echo "Deployment verification failed!" && exit 1
                    fi
                '''
            }
        }

        stage('Cleanup') {
            steps {
                sh 'rm -f deployment.tar.gz'
            }
        }
    }

    post {
        success {
            echo '✅ GitHub to EC2 deployment pipeline executed successfully!'
        }
        failure {
            echo '❌ GitHub to EC2 deployment pipeline failed!'
        }
    }
}
