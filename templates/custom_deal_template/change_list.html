{% extends "admin/change_list.html" %}
{% load i18n admin_urls %}

{% block content %}
<div id="content-main">
    <form id="deal-form" method="post" action="{% url 'admin:create_deal' %}">
        {% csrf_token %}
        <div class="button-group">
            <button type="button" id="create-deal-btn" class="btn btn-primary">Create Deal</button>
        <button type="button" id="show-deals-btn" class="btn btn-success">Show Deals</button>
        </div>


        <!-- Deal creation modal -->
        <div id="deal-modal" style="display: none;">
            <h3>Create Deal</h3>
            <div class="form-group">
    <label for="deal-name">Deal Name:</label>
    <div class="input-container">
        <input type="text" id="deal-name" name="deal_name" required>
        <span id="deal-name-error" class="error-message">Deal with this name already exists</span>
    </div>
</div>

            <div class="form-group">
                <label for="deal-price">Total Price:</label>
                <input type="text" id="deal-price" name="deal_price" readonly>
            </div>
            <div class="form-group">
                <label for="deal-discounted-price">Deal Price:</label>
                <input type="text" id="deal-discounted-price" name="deal_discounted_price" required>
            </div>
            <div class="form-group">
                <label for="deal-is-active">Is Active:</label>
                <input type="checkbox" id="deal-is-active" name="deal_is_active">
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save Deal</button>
            </div>
        </div>

        <div id="services-container" class="content-container">
            <table id="services-table" class="tree-grid">
                <thead>
                    <tr>
                        <th>{% trans "Services" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in result_list %}
                        <tr class="parent-row" data-id="{{ item.id }}">
                            <td>
                                <div class="name-column">
                                    <input type="checkbox" name="services" value="{{ item.id }}" class="item-checkbox" data-price="0" data-type="service">
                                    <span class="caret"></span>
                                    <span class="indent">{{ item.name }}</span>
                                </div>
                            </td>
                        </tr>
                        {% for category in item.categories.all %}
                        <tr class="child-row" data-service="{{ item.id }}" data-category="{{ category.id }}" style="display: none;">
                            <td colspan="5">
                                <table class="nested-table">
                                    <thead>
                                        <tr>
                                            <th>{% trans "Name" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <div class="name-column">
                                                    <input type="checkbox" name="categories" value="{{ category.id }}" class="item-checkbox" data-price="0" data-type="category" data-parent="{{ item.id }}">
                                                    <span class="category-caret"></span>
                                                    <span class="indent">{{ category.name }}</span>
                                                </div>
                                            </td>
                                        </tr>
                                        {% for subservice in category.category_service.all %}
                                        {% if not subservice.subservice %}
                                        <tr class="subservice-row" data-id="{{ subservice.id }}" data-category="{{ category.id }}" style="display: none;">
                                            <td colspan="5">
                                                <table class="nested-table">
                                                    <thead>
                                                        <tr>
                                                            <th>{% trans "Name" %}</th>
                                                            <th>{% trans "Price" %}</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>
                                                                <div class="name-column">
                                                                    <input type="checkbox" name="subservices" value="{{ subservice.id }}" class="item-checkbox" data-price="{{ subservice.price }}" data-type="subservice" data-parent="{{ category.id }}">
                                                                    <span class="subservice-caret"></span>
                                                                    <span class="indent">{{ subservice.name }}</span>
                                                                </div>
                                                            </td>
                                                            <td>{{ subservice.price }}</td>
                                                        </tr>
                                                        {% for nested_subservice in subservice.subservice_category.all %}
                                                        <tr class="nested-subservice-row" data-subservice="{{ subservice.id }}" data-subservicenested="{{ nested_subservice.id }}" style="display: none;">
                                                            <td colspan="8">
                                                                <table class="nested-table">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>{% trans "Name" %}</th>
                                                                            <th>{% trans "Price" %}</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        <tr>
                                                                            <td>
                                                                                <div class="name-column">
                                                                                    <input type="checkbox" name="nested_subservices" value="{{ nested_subservice.id }}" class="item-checkbox" data-price="{{ nested_subservice.price }}" data-type="nested_subservice" data-parent="{{ subservice.id }}">
                                                                                    <span class="nested-subservice-caret"></span>
                                                                                    <span class="indent">{{ nested_subservice.name }}</span>
                                                                                </div>
                                                                            </td>
                                                                            <td>{{ nested_subservice.price }}</td>
                                                                        </tr>
                                                                        {% for sub_nested_subservice in nested_subservice.subservice_category.all %}
                                                                        <tr class="sub-nested-subservice-row" data-subservicenested="{{ nested_subservice.id }}" style="display: none;">
                                                                            <td colspan="8">
                                                                                <table class="nested-table">
                                                                                    <thead>
                                                                                        <tr>
                                                                                            <th>{% trans "Name" %}</th>
                                                                                            <th>{% trans "Price" %}</th>
                                                                                        </tr>
                                                                                    </thead>
                                                                                    <tbody>
                                                                                        <tr>
                                                                                            <td>
                                                                                                <div class="name-column">
                                                                                                    <input type="checkbox" name="sub_nested_subservices" value="{{ sub_nested_subservice.id }}" class="item-checkbox" data-price="{{ sub_nested_subservice.price }}" data-type="sub_nested_subservice" data-parent="{{ nested_subservice.id }}">
                                                                                                    <span class="indent">{{ sub_nested_subservice.name }}</span>
                                                                                                </div>
                                                                                            </td>
                                                                                            <td>{{ sub_nested_subservice.price }}</td>
                                                                                        </tr>
                                                                                        {% for sub_sub_nested_subservice in sub_nested_subservice.subservice_category.all %}
                                                                                        <tr class="sub-sub-nested-subservice-row" data-sub-nested-subservicenested="{{ sub_nested_subservice.id }}" style="display: none;">
                                                                                            <td colspan="8">
                                                                                                <table class="nested-table">
                                                                                                    <thead>
                                                                                                        <tr>
                                                                                                            <th>{% trans "Name" %}</th>
                                                                                                            <th>{% trans "Price" %}</th>
                                                                                                        </tr>
                                                                                                    </thead>
                                                                                                    <tbody>
                                                                                                        <tr>
                                                                                                            <td>
                                                                                                                <div class="name-column">
                                                                                                                    <span class="indent">{{ sub_sub_nested_subservice.name }}</span>
                                                                                                                </div>
                                                                                                            </td>
                                                                                                            <td>{{ sub_sub_nested_subservice.price }}</td>
                                                                                                        </tr>
                                                                                                    </tbody>
                                                                                                </table>
                                                                                            </td>
                                                                                        </tr>
                                                                                        {% endfor %}
                                                                                    </tbody>
                                                                                </table>
                                                                            </td>
                                                                        </tr>
                                                                        {% endfor %}
                                                                    </tbody>
                                                                </table>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </td>
                                        </tr>
                                        {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
            <div class="pagination-container">
    {% if page_obj.paginator.num_pages > 1 %}
    <ul class="pagination">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?p={{ page_obj.previous_page_number }}">&laquo; {% trans "Previous" %}</a>
        </li>
        {% endif %}
        {% for i in page_obj.paginator.page_range %}
        <li class="page-item{% if page_obj.number == i %} active{% endif %}">
            <a class="page-link" href="?p={{ i }}">{{ i }}</a>
        </li>
        {% endfor %}
        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?p={{ page_obj.next_page_number }}">{% trans "Next" %} &raquo;</a>
        </li>
        {% endif %}
    </ul>
    {% endif %}
</div>

        </div>

        <!-- Deals table -->
        <div id="deals-container" style="display: none; margin-top: 20px;">
            <h3>{% trans "Created Deals" %}</h3>
            <input type="text" id="search-deals-input" placeholder="Search Deals by Name..." class="form-control" style="margin-bottom: 20px; width: 300px;">
            <table id="deals-table" class="tree-grid" style="table-layout: auto;">
                <thead>
                    <tr>
                        <th style="min-width: 100px;">{% trans "Deal Name" %}</th>
                <th class="right-align" style="width: 20%;">{% trans "Deal Price" %}</th>
                <th class="center-align" style="width: auto;">{% trans "Included Items" %}</th>
                <th class="center-align" style="width: 10%;">{% trans "Is Active" %}</th>
                <th class="center-align" style="width: 10%;">{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody id="deals-tbody"></tbody>
            </table>
        </div>
    </form>
</div>

<style>

    #services-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed; /* Ensure fixed table layout */
}

#services-table th, #services-table td {
    padding: 12px;
    border: 1px solid #ddd;
    text-align: left;
    white-space: nowrap;
    width: 100%; /* Set a fixed width for each column */
}

#services-table th {
    background-color: #f2f2f2;
}

.child-row, .subservice-row, .nested-subservice-row, .sub-nested-subservice-row {
    display: none; /* Initially hidden */
}

    .tree-grid, .nested-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }

    .tree-grid th, .tree-grid td, .nested-table th, .nested-table td {
        padding: 12px;
        border: 1px solid #ddd;
        text-align: left;
        white-space: nowrap;
    }

    .tree-grid th, .nested-table th {
        background-color: #f2f2f2;
    }

    .child-row {
        background-color: #f9f9f9;
    }

    .caret, .category-caret, .subservice-caret, .nested-subservice-caret {
        cursor: pointer;
        user-select: none;
        margin-left: 10px;
    }

    .caret::before, .category-caret::before, .subservice-caret::before, .nested-subservice-caret::before {
        content: "\25B6";
        color: black;
        display: inline-block;
        margin-right: 6px;
        transition: transform 0.3s ease;
    }

    .caret-down::before, .category-caret-down::before, .subservice-caret-down::before, .nested-subservice-caret-down::before {
        transform: rotate(90deg);
    }

    .parent-row, .child-row, .subservice-row, .nested-subservice-row, .sub-nested-subservice-row {
        height: 40px;
    }

    .name-column {
        display: flex;
        align-items: center;
    }

    .indent {
        margin-left: 10px; /* Adjust the indentation as needed */
    }

    .btn {
        margin-right: .5px;
        padding: 5px;
        font-size: 12px; /* Adjust font size as needed */
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 5px 10px;
        text-decoration: none;
        border-radius: 3px;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 5px 10px;
        text-decoration: none;
        border-radius: 3px;
    }

    .btn-success {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 5px 10px;
        text-decoration: none;
        border-radius: 3px;
    }

    .btn-primary:hover, .btn-danger:hover, .btn-success:hover {
        opacity: 0.8;
    }

    .form-group {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }

    .form-group label {
        width: 120px; /* Adjust this width as needed */
        margin-right: 10px;
        text-align: right;
    }

    .form-group input {
        flex: 1;
        padding: 5px;
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        align-items: center;
    }

    .form-actions button {
        margin-left: 10px;
    }

    .included-items-container {
        display: flex;
        flex-wrap: wrap;
    }

    .included-item {
        margin-right: 1px; /* Adjust margin as needed */
    }

    #deal-modal {
        padding: 20px;
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 5px;
        width: 500px; /* Adjust width as needed */
        margin: 20px auto;
    }

    .right-align {
    text-align: right !important;
}

.center-align {
    text-align: center !important;
}
      .error-message {
        display: none;
        color: red;
        font-size: 12px;
        margin-top: 5px;
    }

    .error-input {
        border: 2px solid red;
    }

.form-group {
    display: flex;
    align-items: flex-start; /* Changed from center to flex-start */
    margin-bottom: 15px;
}

.form-group label {
    width: 120px; /* Adjust this width as needed */
    margin-right: 10px;
    text-align: right;
    padding-top: 8px; /* Added padding to align with input */
}

.form-group .input-container {
    flex: 1;
}

.input-container {
    display: flex;
    flex-direction: column;
    width: 100%;
}

    .form-group input[type="text"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .form-actions {
        margin-top: 20px;
    }

    .form-group {
    display: flex;
    align-items: center;
}

.form-group label {
    margin-right: 10px; /* Add some space between the label and the checkbox */
}

    .button-group{
    margin-bottom:20px;}

    .button-group button{
    margin-right:10px;
    }

    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }

    .pagination {
        display: flex;
        list-style: none;
        padding: 0;
    }

    .page-item {
        margin: 0 5px;
    }

    .page-link {
        padding: 8px 12px;
        border: 1px solid #ddd;
        color: #007bff;
        text-decoration: none;
        border-radius: 3px;
    }

    .page-link:hover {
        background-color: #f2f2f2;
    }

    .active .page-link {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Toggle categories within a service
    document.querySelectorAll('.caret').forEach(function (caret) {
        var parentRow = caret.closest('.parent-row');
        var id = parentRow.dataset.id;
        var categories = document.querySelectorAll('[data-service="' + id + '"]');
        if (categories.length > 0) {
            caret.addEventListener('click', function () {
                categories.forEach(function (category) {
                    category.style.display = category.style.display === 'none' ? 'table-row' : 'none';
                });
                caret.classList.toggle('caret-down');
            });
        } else {
            caret.style.display = 'none'; // Hide caret if no child categories found
        }
    });

    // Toggle subservices within a category
    document.querySelectorAll('.category-caret').forEach(function (categoryCaret) {
        var childRow = categoryCaret.closest('.child-row');
        var categoryId = childRow.dataset.category;
        var subservices = document.querySelectorAll('[data-category="' + categoryId + '"].subservice-row');
        if (subservices.length > 0) {
            categoryCaret.addEventListener('click', function () {
                subservices.forEach(function (subservice) {
                    subservice.style.display = subservice.style.display === 'none' ? 'table-row' : 'none';
                });
                categoryCaret.classList.toggle('category-caret-down');
            });
        } else {
            categoryCaret.style.display = 'none'; // Hide caret if no child subservices found
        }
    });

    // Toggle nested subservices within a subservice
    document.querySelectorAll('.subservice-caret').forEach(function (subserviceCaret) {
        var subserviceRow = subserviceCaret.closest('.subservice-row');
        var subserviceId = subserviceRow.dataset.id;
        var nestedSubservices = document.querySelectorAll('[data-subservice="' + subserviceId + '"].nested-subservice-row');
        if (nestedSubservices.length > 0) {
            subserviceCaret.addEventListener('click', function () {
                nestedSubservices.forEach(function (nestedSubservice) {
                    nestedSubservice.style.display = nestedSubservice.style.display === 'none' ? 'table-row' : 'none';
                });
                subserviceCaret.classList.toggle('subservice-caret-down');
            });
        } else {
            subserviceCaret.style.display = 'none'; // Hide caret if no child nested subservices found
        }
    });

    // Toggle sub-nested subservices within a nested subservice
    document.querySelectorAll('.nested-subservice-caret').forEach(function (nestedSubserviceCaret) {
        var nestedSubserviceRow = nestedSubserviceCaret.closest('.nested-subservice-row');
        var nestedSubserviceId = nestedSubserviceRow.dataset.subservicenested;
        var subNestedSubservices = document.querySelectorAll('[data-subservicenested="' + nestedSubserviceId + '"].sub-nested-subservice-row');
        if (subNestedSubservices.length > 0) {
            nestedSubserviceCaret.addEventListener('click', function () {
                subNestedSubservices.forEach(function (subNestedSubservice) {
                    subNestedSubservice.style.display = subNestedSubservice.style.display === 'none' ? 'table-row' : 'none';
                });
                nestedSubserviceCaret.classList.toggle('nested-subservice-caret-down');
            });
        } else {
            nestedSubserviceCaret.style.display = 'none'; // Hide caret if no child sub-nested subservices found
        }
    });

    // Handle checkbox functionality and calculate total price
    document.querySelectorAll('.item-checkbox').forEach(function (checkbox) {
        checkbox.addEventListener('change', function () {
            toggleNestedCheckboxes(checkbox);
            updateTotalPrice();
        });
    });

    function toggleNestedCheckboxes(checkbox) {
        var type = checkbox.dataset.type;
        var id = checkbox.value;

        if (checkbox.checked) {
            // Check all children if parent is checked
            document.querySelectorAll('.item-checkbox[data-parent="' + id + '"]').forEach(function (childCheckbox) {
                childCheckbox.checked = true;
                toggleNestedCheckboxes(childCheckbox); // Recursive check
            });
        } else {
            // Uncheck all children if parent is unchecked
            document.querySelectorAll('.item-checkbox[data-parent="' + id + '"]').forEach(function (childCheckbox) {
                childCheckbox.checked = false;
                toggleNestedCheckboxes(childCheckbox); // Recursive uncheck
            });
        }
    }

    function updateTotalPrice() {
        var totalPrice = 0;
        document.querySelectorAll('.item-checkbox').forEach(function (checkbox) {
            if (checkbox.checked) {
                totalPrice += parseFloat(checkbox.dataset.price);
            }
        });
        // Update total price display
        document.getElementById('deal-price').value = totalPrice.toFixed(2);
    }
const dealForm = document.getElementById('deal-form');
    const dealNameInput = document.getElementById('deal-name');
    const dealNameError = document.getElementById('deal-name-error');

    dealForm.addEventListener('submit', function (e) {
        e.preventDefault();

        const dealName = dealNameInput.value;

        if (dealName) {
            fetch(`{% url 'check_deal_name' %}?deal_name=` + encodeURIComponent(dealName))
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        dealNameError.style.display = 'inline';
                    } else {
                        dealNameError.style.display = 'none';
                        dealForm.submit();  // Submit the form if the deal name is valid
                    }
                });
        }
    });
    // Show deals button functionality
    document.getElementById('show-deals-btn').addEventListener('click', function () {
        document.getElementById('deal-modal').style.display = 'none';
        document.getElementById('services-container').style.display = 'none';
        document.getElementById('deals-container').style.display = 'block';
        fetchAllDealsForTemplate();
    });

    // Create deal button functionality
    document.getElementById('create-deal-btn').addEventListener('click', function () {
        document.getElementById('deal-modal').style.display = 'block';
        document.getElementById('services-container').style.display = 'block';
        document.getElementById('deals-container').style.display = 'none';
    });

    function fetchAllDealsForTemplate() {
        fetch('{% url "fetch_all_deals_for_template" %}')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                var dealsTbody = document.getElementById('deals-tbody');
                dealsTbody.innerHTML = ''; // Clear existing deals
                data.forEach(function (deal) {
                    var includedItems = deal.included_items.map(item => `<span class="included-item">${item}</span>`).join(', ');
                    var dealRow = `<tr>
                    <td style="min-width: 100px;">${deal.name}</td>
                    <td class="right-align">${deal.discounted_price}</td>
                    <td style="width: auto;">
                        <div class="included-items-container">${includedItems}</div>
                    </td>
                    <td class="center-align">${deal.is_active ? '✔' : '✖'}</td>
                    <td class="center-align">
                        <button class="btn btn-sm btn-primary edit-deal-btn" data-id="${deal.id}" title="{% trans "Edit" %}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger delete-deal-btn" data-id="${deal.id}" title="{% trans "Delete" %}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>`;
                    dealsTbody.innerHTML += dealRow;  // Adding the deal row to the table body
                });


                // Show the deals list
                document.getElementById('deals-container').style.display = 'block';

                // Add event listeners for delete buttons
                document.querySelectorAll('.delete-deal-btn').forEach(function (button) {
                    button.addEventListener('click', function () {
                        var dealId = this.dataset.id;
                        if (confirm('Are you sure you want to delete this deal?')) {
                            deleteDeal(dealId);
                        }
                    });
                });

                // Add event listeners for edit buttons
                document.querySelectorAll('.edit-deal-btn').forEach(function (button) {
                    button.addEventListener('click', function () {
                        var dealId = this.dataset.id;
                        window.location.href = `{% url 'admin:policies_dealmodel_change' '0' %}`.replace('0', dealId);
                    });
                });
            })
            .catch(error => console.error('Error fetching deals:', error));
    }

    function deleteDeal(dealId) {
        fetch(`{% url 'delete_deal' deal_id=0 %}`.replace('0', dealId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log("Deal deleted successfully");
                fetchAllDealsForTemplate(); // Refresh the deals list
            } else {
                console.error("Error deleting deal:", data.error);
            }
        })
        .catch(error => console.error('Error deleting deal:', error));
    }
    document.getElementById('search-deals-input').addEventListener('input', function() {
        var searchValue = this.value.toLowerCase();
        var dealRows = document.querySelectorAll('#deals-tbody tr');
        dealRows.forEach(function(row) {
            var dealName = row.querySelector('td').textContent.toLowerCase();
            if (dealName.includes(searchValue)) {
                row.style.display = ''; // Show the row
            } else {
                row.style.display = 'none'; // Hide the row
            }
        });
    });
});
</script>
{% endblock %}
